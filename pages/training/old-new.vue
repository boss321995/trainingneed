<template>
  <div class="max-w-2xl mx-auto py-8 px-4">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">
        {{ isManager ? '‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ' : '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°' }}
      </h1>
      <p class="text-gray-600">
        {{ isManager ? 
           '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ï‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏≠‡∏Å ‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 
           '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î' }}
      </p>
    </div>

    <form @submit.prevent="handleSubmit" class="space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-center">
            <input
              id="technical_electrical"
              v-model="form.course_types"
              value="technical_electrical"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="technical_electrical" class="ml-2 text-sm text-gray-700">
              ‚ö° ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏≠‡∏Å
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="technical_maintenance"
              v-model="form.course_types"
              value="technical_maintenance"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="technical_maintenance" class="ml-2 text-sm text-gray-700">
              üîß ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="administrative"
              v-model="form.course_types"
              value="administrative"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="administrative" class="ml-2 text-sm text-gray-700">
              üìã ‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="financial"
              v-model="form.course_types"
              value="financial"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="financial" class="ml-2 text-sm text-gray-700">
              üí∞ ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="safety"
              v-model="form.course_types"
              value="safety"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="safety" class="ml-2 text-sm text-gray-700">
              ü¶∫ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="leadership"
              v-model="form.course_types"
              value="leadership"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="leadership" class="ml-2 text-sm text-gray-700">
              üëë ‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="soft_skills"
              v-model="form.course_types"
              value="soft_skills"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="soft_skills" class="ml-2 text-sm text-gray-700">
              üí¨ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="compliance"
              v-model="form.course_types"
              value="compliance"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="compliance" class="ml-2 text-sm text-gray-700">
              üìú ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="customer_service"
              v-model="form.course_types"
              value="customer_service"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="customer_service" class="ml-2 text-sm text-gray-700">
              ü§ù ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </label>
          </div>
          <div class="flex items-center">
            <input
              id="digital_literacy"
              v-model="form.course_types"
              value="digital_literacy"
              type="checkbox"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label for="digital_literacy" class="ml-2 text-sm text-gray-700">
              üíª ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•
            </label>
          </div>
        </div>
        <p class="mt-2 text-xs text-gray-500">
          {{ isManager ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ï‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô' }}
        </p>
      </div>

      <div>
        <div class="flex items-center justify-between mb-3">
          <label class="block text-sm font-medium text-gray-700">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
          <button
            type="button"
            @click="addCourse"
            class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
          </button>
        </div>
        
        <div class="space-y-4">
          <div
            v-for="(course, index) in form.courses"
            :key="index"
            class="border border-gray-200 rounded-lg p-4 bg-gray-50"
          >
            <div class="flex items-start justify-between mb-3">
              <h4 class="text-sm font-medium text-gray-700">
                ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà {{ index + 1 }}
              </h4>
              <button
                v-if="form.courses.length > 1"
                type="button"
                @click="removeCourse(index)"
                class="text-red-600 hover:text-red-800 text-sm"
              >
                ‚ùå ‡∏•‡∏ö
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
                <input
                  v-model="course.title"
                  type="text"
                  required
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô"
                />
              </div>
              
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°</label>
                <input
                  v-model.number="course.participants"
                  type="number"
                  min="1"
                  required
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏≠‡∏ö‡∏£‡∏°</label>
        <select
          v-model="form.quarter"
          required
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
        >
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
          <option value="Q1">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 1 (‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°-‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°)</option>
          <option value="Q2">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 2 (‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô-‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô)</option>
          <option value="Q3">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 3 (‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°-‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô)</option>
          <option value="Q4">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 4 (‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°-‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°)</option>
        </select>
      </div>



      <div>
        <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
        <textarea
          v-model="form.free_text"
          rows="4"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏†‡∏≤‡∏Ñ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏™‡∏ô‡∏≤‡∏°, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"
        ></textarea>
      </div>

      <!-- Summary Section -->
      <div v-if="form.course_types.length > 0 || form.courses.some(c => c.title)" class="bg-green-50 p-4 rounded-md">
        <h3 class="text-sm font-medium text-gray-700 mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</h3>
        
        <div v-if="form.course_types.length > 0" class="mb-3">
          <span class="text-xs font-medium text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°:</span>
          <div class="flex flex-wrap gap-2 mt-1">
            <span
              v-for="type in form.course_types"
              :key="type"
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800"
            >
              {{ getCourseTypeLabel(type) }}
            </span>
          </div>
        </div>

        <div v-if="form.courses.some(c => c.title)" class="mb-3">
          <span class="text-xs font-medium text-gray-600">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
          <ul class="mt-1 space-y-1">
            <li
              v-for="(course, index) in form.courses.filter(c => c.title)"
              :key="index"
              class="text-xs text-gray-700 flex justify-between"
            >
              <span>{{ index + 1 }}. {{ course.title }}</span>
              <span class="font-medium text-indigo-600">{{ course.participants }} ‡∏Ñ‡∏ô</span>
            </li>
          </ul>
        </div>

        <div class="text-xs text-gray-500">
          ‡∏£‡∏ß‡∏° {{ form.courses.filter(c => c.title).length }} ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ |
          ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ form.courses.reduce((sum, course) => sum + (course.participants || 0), 0) }} ‡∏Ñ‡∏ô
        </div>
      </div>

      <div class="bg-blue-50 p-4 rounded-md">
        <h3 class="text-sm font-medium text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-medium">‡∏ä‡∏∑‡πà‡∏≠:</span> {{ user?.name || 'N/A' }}
          </div>
          <div>
            <span class="font-medium">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</span> {{ user?.department || 'N/A' }}
          </div>
          <div>
            <span class="font-medium">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span> {{ user?.position || 'N/A' }}
          </div>
          <div>
            <span class="font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> 
            <span class="text-blue-600 font-medium">
              {{ isManager ? 'üéØ ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô - ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏ú‡∏ô' : 'üìù ‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢' }}
            </span>
          </div>
        </div>
      </div>

      <div>
        <button
          type="submit"
          :disabled="loading"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
        >
          {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : (isManager ? 'üéØ ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏ú‡∏ô‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°' : 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') }}
        </button>
      </div>

      <div v-if="error" class="text-red-600 text-sm text-center">
        {{ error }}
      </div>
    </form>
  </div>
</template>

<script setup>
import { useAuthStore } from '~/stores/auth'

definePageMeta({
  middleware: 'auth'
})

const authStore = useAuthStore()
const user = computed(() => authStore.user)

// Check if user is a manager (Level 8 or higher)
const isManager = computed(() => {
  return user.value && user.value.level >= 8
})

const form = reactive({
  course_types: [], // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö multiple selection
  courses: [{ title: '', participants: 1 }], // array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
  quarter: '',
  free_text: ''
})

const loading = ref(false)
const error = ref('')

// Functions for managing multiple courses
const addCourse = () => {
  form.courses.push({ title: '', participants: 1 })
}

const removeCourse = (index) => {
  if (form.courses.length > 1) {
    form.courses.splice(index, 1)
  }
}

// Get course type label
const getCourseTypeLabel = (type) => {
  const labels = {
    'technical_electrical': '‚ö° ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏≠‡∏Å',
    'technical_maintenance': 'üîß ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',
    'administrative': 'üìã ‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£',
    'financial': 'üí∞ ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
    'safety': 'ü¶∫ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
    'leadership': 'üëë ‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',
    'soft_skills': 'üí¨ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£',
    'compliance': 'üìú ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö',
    'customer_service': 'ü§ù ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
    'digital_literacy': 'üíª ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•'
  }
  return labels[type] || type
}

const handleSubmit = async () => {
  // Validation
  if (form.course_types.length === 0) {
    error.value = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'
    return
  }

  if (form.courses.some(course => !course.title.trim())) {
    error.value = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
    return
  }

  loading.value = true
  error.value = ''

  try {
    const sessionValid = await authStore.validateToken({ keepStateOnError: true })

    if (!sessionValid || !authStore.isAuthenticated) {
      error.value = '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
      loading.value = false
      await navigateTo('/login?reason=expired')
      return
    }

    // Submit each course as a separate training need
    const submitPromises = form.courses.map(course => {
      return fetch('http://localhost:4001/api/training-needs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          employee_id: user.value?.id,
          course_type: form.course_types.join(', '), // Join multiple types
          course_title: course.title,
          quarter: form.quarter,
          participants: course.participants,
          free_text: form.free_text
        })
      })
    })

    const responses = await Promise.all(submitPromises)
    const results = await Promise.all(responses.map(res => res.json()))

    const failedSubmissions = results.filter(result => !result.ok)
    
    if (failedSubmissions.length === 0) {
      await navigateTo('/')
    } else {
      error.value = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${results.length - failedSubmissions.length}/${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
    }
  } catch (err) {
    console.error('Submit error:', err)
    error.value = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
  } finally {
    loading.value = false
  }
}
</script>
